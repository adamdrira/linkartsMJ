<div class="chat-container" >

    
    <div class="main-left-container">


        <!-------------------------------------->
        <!-------------------------------------->
        <!--PARTIE HAUTE DU CHAT-->
        <!-------------------------------------->
        <!-------------------------------------->
        <div class="top-container" [ngClass]="{'margin-bottom-for-alert':block_chat || spam=='true'}">


            <div class="display-flex">
                
                <button (click)="arrow_back();" class="arrow-back" [@enterAnimation]>
                    <mat-icon [ngClass]="{'invisible': !show_icon }">keyboard_arrow_left</mat-icon>
                </button>

                <ng-container *ngIf="friend_type=='user'">
                    <a [routerLink]="open_friend_link()" (click)="set_not_using_chat()" class="profile-picture-container"
                        [ngClass]="{'shiny': !top_pp_loaded }">
                        <img [src]="friend_picture" (load)="top_pp_is_loaded()" [ngClass]="{'invisible': !top_pp_loaded }">
                    </a>
                    <a [routerLink]="open_friend_link()" (click)="set_not_using_chat()" class="friend-link">
                        <span>
                            <div>
                                {{friend_name}}
                            </div>
                            <mat-icon *ngIf="friend_certification" [ngClass]="{'invisible': !show_icon }"
                            matTooltip="Compte certifié" 
                            matTooltipClass='linkarts-tooltip' 
                            [matTooltipPosition]="'below'"
                            [matTooltipShowDelay]="200">verified</mat-icon>
                        </span>
                    </a>
                </ng-container>
                
                <ng-container *ngIf="friend_type!='user'">
                    <div class="profile-picture-container"
                        [ngClass]="{'shiny': !top_pp_loaded }">
                        <img [src]="friend_picture" (load)="top_pp_is_loaded()" [ngClass]="{'invisible': !top_pp_loaded }">
                    </div>
                    <div class="friend-link">
                        <span>
                            <div>
                                {{friend_name}} 
                            </div>
                        </span>
                    </div>
                </ng-container>


                <button style="position:relative;" (click)="contract();" *ngIf="spam!='true' && contract_data_retrieved" [@enterAnimation]
                matTooltip="Contrat"
                matTooltipClass='linkarts-tooltip'
                [matTooltipPosition]="'below'"
                [matTooltipShowDelay]="100">
                    <mat-icon [ngClass]="{'invisible': !show_icon }">assignment</mat-icon>
                    <div class="number-of-notifs contract" (click)="contract();" [ngClass]="{'green': show_green_contract_notification,'red': show_red_contract_notification}" >
                    </div>
                </button>

                <button *ngIf="search_popup_closed && !show_research_results" (click)="search_in_conv();" [@enterAnimation]>
                    <mat-icon [ngClass]="{'invisible': !show_icon }">search</mat-icon>
                </button>

                <!-- --------------------------------OPTIONS--------------------------------- -->
                <!-- --------------------------------OPTIONS--------------------------------- -->
                <!-- --------------------------------OPTIONS--------------------------------- -->

                <!-- --------------------------------POUR LES UTILISATEURS--------------------------------- -->
                <ng-container *ngIf="friend_type=='user' && friend_id!=current_user_id">

                    <button [matMenuTriggerFor]="artworkOptions" [@enterAnimation] *ngIf="!(3>=friend_id && friend_type=='user')">
                        <mat-icon [ngClass]="{'invisible': !show_icon }">more_horiz</mat-icon>
                    </button>

                    <mat-menu #artworkOptions="matMenu" class="chat-mat-menu">
                        <button class="chat-menu-item" (click)="contract();" mat-menu-item>
                            <mat-icon [ngClass]="{'invisible': !show_icon }">assignment</mat-icon>
                            <span>Proposer un contrat</span>
                        </button>
                        <button  class="chat-menu-item" *ngIf="spam!='true' && chat_friend_id>0 && list_of_friends_ids.includes(friend_id)" mat-menu-item  (click)="remove_contact()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">person_off</mat-icon>
                            <span>Retirer de mes contacts</span>
                        </button>
                        <button class="chat-menu-item" *ngIf="spam=='true' && list_of_spams_ids.includes(friend_id)" mat-menu-item  (click)="remove_spam()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">person_off</mat-icon>
                            <span>Retier de mes invitations</span>
                        </button>
                        <button *ngIf="!block_chat" class="chat-menu-item" mat-menu-item (click)="block_user()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">block</mat-icon>
                            <span>Bloquer l'utilisateur</span>
                        </button>
                        <button *ngIf="block_chat && who_blocked=='me'" class="chat-menu-item"  mat-menu-item (click)="unblock_user()"> 	
                            <mat-icon [ngClass]="{'invisible': !show_icon }">report_off</mat-icon>
                            <span>Débloquer l'utilisateur</span>
                        </button>
                    </mat-menu>

                    <!-- --------------------------------POUR LES GROUPES--------------------------------- -->
                </ng-container>
                <ng-container *ngIf="friend_type=='group'">
                    <button [matMenuTriggerFor]="artworkOptions" [@enterAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">more_horiz</mat-icon>
                    </button>

                    <mat-menu #artworkOptions="matMenu" class="chat-mat-menu">
                        <button class="chat-menu-item" mat-menu-item (click)="contract();">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">assignment</mat-icon>
                            <span>Proposer un contrat</span>
                        </button>
                        <button class="chat-menu-item" mat-menu-item (click)="change_profile_picture()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">camera_alt</mat-icon>
                            <span>Modifier la photo de profil</span>
                        </button>
                        <button class="chat-menu-item" mat-menu-item (click)="add_a_friend()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">person_add</mat-icon>
                            <span>Ajouter un contact</span>
                        </button>
                        <button class="chat-menu-item" mat-menu-item (click)="display_members_of_the_group()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">dehaze</mat-icon>
                            <span>Liste des membres</span>
                        </button>
                        <button class="chat-menu-item" mat-menu-item (click)="exit_group()">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                            <span>Quitter le groupe</span>
                        </button>

                    </mat-menu>
                </ng-container>
                
                <button class="show-me-on-small-screen" (click)="change_right_container();" [@enterAnimation]>
                    <mat-icon [ngClass]="{'invisible': !show_icon }">info</mat-icon>

                    <div class="number-of-notifs" (click)="change_right_container();" *ngIf="show_notification_message && number_of_sections_unseen>0 && !right_container_is_opened">
                    </div>
                </button>

            </div>

            <div *ngIf="show_research_results" class="top-container-search-results">
                <ng-container *ngIf="number_of_messages_found>0">
                    <button (click)="show_next_message_researched()" [@enterFromLeftAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">keyboard_arrow_up</mat-icon>
                    </button>
                    <button (click)="show_precedent_message_researched()" [@enterFromLeftAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">keyboard_arrow_down</mat-icon>
                    </button>
                    <span [@enterFromLeftAnimation]>
                        {{number_click_top}} sur {{number_of_messages_found}} pour "{{message_researched}}"
                    </span>
                    <button (click)="cancel_show_research_results()" [@enterFromLeftAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                    </button>
                </ng-container>

                <ng-container *ngIf="number_of_messages_found==0">
                    <span [@enterFromLeftAnimation]>Aucun résultat</span>
                    <button (click)="cancel_show_research_results()" [@enterFromLeftAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                    </button>
                </ng-container>
            </div>



            <div *ngIf="spam!='false' && !block_chat && response_exist && response_exist_retrieved" class="top-alert-message" [@enterFromTopAnimation]>
                <div class="message">
                    <span>
                        {{friend_name}} ne fait pas partie de vos contacts. Voulez-vous l'ajouter ?
                    </span>
                    <button (click)="add_to_contacts()">
                        <span *ngIf="!show_spinner_add">Ajouter</span>
                        <mat-icon [ngClass]="{'invisible': !show_icon }" *ngIf="!show_spinner_add">person_add</mat-icon>
                        <mat-spinner diameter="20" *ngIf="show_spinner_add" ></mat-spinner>
                    </button>
                </div>
            </div>
            <div *ngIf="spam!='false' && !block_chat && !response_exist && response_exist_retrieved" class="top-alert-message" [@enterFromTopAnimation]>
                <div class="message">
                    <mat-icon [ngClass]="{'invisible': !show_icon }">info_outline</mat-icon>
                    <span> Vous devez attendre que {{friend_name}} réponde à votre message pour l'ajouter à vos contacts</span>
                </div>
            </div>

            <div *ngIf="block_chat" class="top-alert-message" [@enterFromTopAnimation]>
                <div class="message">
                    <mat-icon [ngClass]="{'invisible': !show_icon }">info_outline</mat-icon>
                    <span *ngIf="who_blocked=='user'">
                        Utilisateur suspendu
                    </span>
                    <span *ngIf="who_blocked!='user'">
                        Vous avez bloqué cet utilisateur
                    </span>
                </div>
            </div>

        </div>




        <!-------------------------------------->
        <!-------------------------------------->
        <!--PARTIE MILIEU DU CHAT-->
        <!-------------------------------------->
        <!-------------------------------------->
        <div class="middle-container" #middleContainer>


            <div class="loading-dots-container" *ngIf="!put_messages_visible">
                <div class="loading-dots">
                    &nbsp; <span>.</span><span>.</span><span>.</span>
                </div>
            </div>

            <!--
                    DEBUT DES MESSAGES DE CLASSIQUES
                    DEBUT DES MESSAGES DE CLASSIQUES
                    DEBUT DES MESSAGES DE CLASSIQUES
                    DEBUT DES MESSAGES DE CLASSIQUES
                    DEBUT DES MESSAGES DE CLASSIQUES
                -->
            <div #myScrollContainer (scroll)="onScroll($event)" class="messages-container" [ngClass]="{'invisible':!put_messages_visible}"
                *ngIf="friend_type=='user'">


                <div *ngIf='display_messages' style="width:100%;overflow: hidden;">

                    <div class="loading-dots-container loading-messages" *ngIf="show_spinner">
                        <div class="loading-dots">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>
                    
                    <div *ngIf="trigger_no_more" class="text-in-middle">
                        <span>Début de la discussion : {{list_of_messages_date[list_of_messages.length -1]}}</span>
                    </div>

                    <button [disabled]="show_spinner_for_more" *ngIf="show_research_results && !trigger_no_more" class="show-more" (click)="see_more_messages();">
                        <ng-container *ngIf="!show_spinner_for_more">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">expand_less</mat-icon>
                            <span>Voir plus</span>
                        </ng-container>
                        <div class="loading-dots" *ngIf="show_spinner_for_more">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </button>

                    <div #message_children *ngFor="let item of list_of_messages; let i = index" class="message">

                        <div *ngIf="list_of_messages[list_of_messages.length- i]">
                            <div
                                *ngIf="get_time_of_date(list_of_messages[list_of_messages.length- i].createdAt)!=get_time_of_date(list_of_messages[list_of_messages.length -1 - i].createdAt)
                                    && (list_of_messages[list_of_messages.length -1 - i].createdAt || !today_triggered)" class="text-in-middle">
                                <span>{{show_date_of_timestamp(list_of_messages.length -1 - i)}}</span>

                            </div>
                        </div>

                        <!------------------------------------- MY MESSAGES------------------------------------------->
                        <!------------------------------------- MY MESSAGES------------------------------------------->
                        <!------------------------------------- MY MESSAGES------------------------------------------->


                        <ng-container
                            *ngIf="list_of_messages[list_of_messages.length -1 - i].id_user==current_user_id && !list_of_messages[list_of_messages.length -1 - i].is_from_server">
                            <div class="my-message-content"
                                [ngClass]="{
                                    'contains-picture':(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'less-margin-for-user':(list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i-2].id_user ),
                                    'margin-for-emojis': (list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user || list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver) && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'deleted': list_of_messages[list_of_messages.length -1 - i].status=='deleted',
                                    'padding-for-no-state':
                                        !( ( list_of_messages[list_of_messages.length -1 - i].status=='received' || list_of_messages[list_of_messages.length -1 - i].status=='deleted' ) || 
                                            ( (index_of_show_pp_right==list_of_messages.length -1 - i) && list_of_messages[list_of_messages.length -1 - i].status=='seen' ) ) ,
                                    'message-search-style': searched_message==i  }">


                                <div class="options margin-left" [ngClass]="{ 'opacity1': myMessageOpenedOptions==i }">

                                    <button  (menuClosed)="myMessageOptionsClosed();" (menuOpened)="myMessageOptionsOpened(i);"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].id && list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'" [matMenuTriggerFor]="artworkOptions">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            more_horiz</mat-icon>
                                    </button>
                                    <button (click)="respond_to_message(list_of_messages.length -1 - i)"
                                        *ngIf=" list_of_messages[list_of_messages.length -1 - i].id && list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            reply</mat-icon>
                                    </button>

                                    <button (menuClosed)="myMessageOptionsClosed();" (menuOpened)="myMessageOptionsOpened(i);" (click)="show_reactions(i,$event)" [matMenuTriggerFor]="reactions"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            sentiment_satisfied</mat-icon>
                                    </button>


                                    <mat-menu #reactions="matMenu" class="reactions-mat-menu">
                                        <button class="reaction-menu-item" *ngFor="let emoji of emojis_list; let j=index">
                                            <ngx-emoji (emojiClick)="reaction_click($event,list_of_messages.length -1 - i)" useButton="true" set="apple" emoji="{{emoji}}" size="26"></ngx-emoji>
                                        </button>
                                    </mat-menu>

                                    <mat-menu #artworkOptions="matMenu" class="chat-mat-menu">

                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && !list_of_messages[list_of_messages.length -1 - i].attachment_name.includes('.svg')"
                                            (click)="edit(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">edit
                                            </mat-icon>
                                            <span>Éditer</span>
                                        </button>

                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].is_an_attachment) && list_of_folders_retrieved  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && list_of_folders.length>0 && (list_of_messages[list_of_messages.length -1 - i].id_folder==0 || !list_of_messages[list_of_messages.length -1 - i].id_folder)"
                                            (click)="archive(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">bookmark
                                            </mat-icon>
                                            <span>Archiver</span>
                                        </button>

                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].is_an_attachment) && list_of_folders_retrieved  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && list_of_messages[list_of_messages.length -1 - i].id_folder>0"
                                            (click)="unarchive(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">turned_in_not
                                            </mat-icon>
                                            <span>Désarchiver</span>
                                        </button>

                                        <button class="chat-menu-item" mat-menu-item
                                            (click)="delete_message(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">delete_outline
                                            </mat-icon>
                                            <span>Supprimer</span>
                                        </button>

                                        <div class="chat-menu-item date-menu" mat-menu-item>
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">history
                                            </mat-icon>
                                            <span>{{list_of_messages_date[list_of_messages.length -1 - i]}}</span>
                                        </div>
                                    </mat-menu>
                                </div>



                                <div class="content only-message"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status=='deleted'"><i>Message supprimé</i>
                                </div>

                                <div *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='deleted'"
                                    class="content"

                                    [matTooltip]="!can_show_send_icon?list_of_messages_date[list_of_messages.length -1 - i]:null"
                                    matTooltipClass='linkarts-tooltip'
                                    [matTooltipPosition]="'below'"
                                    [matTooltipShowDelay]="100"

                                    [ngClass]="{
                                        'detect-scroll':can_show_send_icon,
                                        'only-message':
                                        (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] 
                                            && (
                                                   (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user  && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i].is_from_server)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i].is_from_server)

                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                )
                                        ) 
                                        || ( !list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i] 
                                            && (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user 
                                                || list_of_messages[list_of_messages.length- i].is_from_server
                                                || list_of_messages[list_of_messages.length- i-1].date_shown)
                                                ) 
                                        || ( !list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && 
                                            (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user 
                                            || list_of_messages[list_of_messages.length- i-2].is_from_server
                                            || list_of_messages[list_of_messages.length- i-2].date_shown)
                                            )
                                        || ( !list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2]
                                        ),
                                        'my-top-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user && list_of_messages[list_of_messages.length- i-2].id_user==list_of_messages[list_of_messages.length- i-1].id_user)
                                        || (!list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i-2].id_user),
                                        'my-middle-message':list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i-2].id_user  && current_user_id==list_of_messages[list_of_messages.length- i].id_user,
                                        'my-bottom-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id!=list_of_messages[list_of_messages.length- i-2].id_user && current_user_id==list_of_messages[list_of_messages.length- i].id_user)
                                            || (list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i].id_user) }">
                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_a_response"
                                        class="response-content text-with-line-break"
                                        (click)="show_response(list_of_messages.length -1 - i)">
                                            {{list_of_messages[list_of_messages.length -1 - i].message_responding_to}}
                                    </div>
                                    <div class="emoji-reaction-content"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user != list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver">
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver"
                                            [ngClass]="{'second-emoji':list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user }">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                    </div>
                                    <div class="emoji-reaction-content"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user && 
                                            (list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user == list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver)">
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                        <span style="color: darkgrey;padding: 0px 5px 0px 5px;">2</span>
                                    </div>
                                    <div [innerHTML]="convert(list_of_messages.length -1 - i)"*ngIf="!list_of_messages[list_of_messages.length -1 - i].is_an_attachment" class="text-with-line-break">
                                        
                                    </div>
                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_an_attachment">
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message'"
                                            (click)="show_images(list_of_messages.length -1 - i)"
                                            class="image-container">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                               
                                                [customObservable]="scroll"
                                                *ngIf="can_load_images"
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy"  >
                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment'"
                                            class="image-container"
                                            (click)="show_images(list_of_messages.length -1 - i)">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                            [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                            [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">
                                        </div>

                                    
                                        <div class="d-flex align-items-center" *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='file_attachment'">
                                            <div class="attachment-icon" [@enterAnimation]>
                                                <mat-icon [ngClass]="{'invisible': !show_icon }">insert_drive_file</mat-icon>
                                            </div>
                                            <a [href]="list_of_messages_files[list_of_messages.length -1 - i]" [download]="list_of_messages[list_of_messages.length -1 - i].attachment_name">{{list_of_messages[list_of_messages.length -1 - i].attachment_name}}</a>
                                        </div>
                                    
                                    </div>
                                </div>

                                <div class="state"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status=='received' || list_of_messages[list_of_messages.length -1 - i].status=='deleted'" [@enterAnimation]>
                                    <div>
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">done</mat-icon>
                                    </div>
                                </div>

                                
                                <div 
                                matTooltip="vu"
                                matTooltipClass='linkarts-tooltip'
                                [matTooltipPosition]="'below'"
                                [matTooltipShowDelay]="100" *ngIf="(index_of_show_pp_right==list_of_messages.length -1 - i) && list_of_messages[list_of_messages.length -1 - i].status=='seen'" class="state"  [@enterAnimation]>
                                    <div class="friend-picture" [ngClass]="{'shiny':!list_of_pp_loaded_classic[list_of_messages.length -1 - i]}">
                                        <img (load)="loaded_image(-(list_of_messages.length -1 - i)-1)"
                                            [ngClass]="{'invisible':!list_of_pp_loaded_classic[list_of_messages.length -1 - i]}"
                                            [src]="friend_picture">
                                    </div>
                                </div>
                            </div>

                        </ng-container>

                        <!------------------------------------- FRIEND MESSAGES------------------------------------------->
                        <!------------------------------------- FRIEND USERS MESSAGES------------------------------------------->
                        <!------------------------------------- FRIEND USERS MESSAGES------------------------------------------->

                        <ng-container
                            *ngIf="list_of_messages[list_of_messages.length -1 - i].id_user!=current_user_id && !list_of_messages[list_of_messages.length -1 - i].is_from_server">

                            <div class="friend-message-content"
                                [ngClass]="{ 
                                    'contains-picture':(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')   && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'less-margin-for-user':list_of_messages[list_of_messages.length- i-2] &&  !list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length -1 - i].id_user==list_of_messages[list_of_messages.length- i-2].id_user,
                                    'margin-for-emojis': (list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user || list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver)  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'deleted': list_of_messages[list_of_messages.length -1 - i].status=='deleted',
                                    'padding-for-no-state': !( list_of_show_pp_left[list_of_messages.length -1 - i] ),
                                    'message-search-style': searched_message==i  }">

                                


                                <div *ngIf="list_of_show_pp_left[list_of_messages.length -1 - i]" class="state" [@enterAnimation]>
                                    <div class="friend-picture" [ngClass]="{'shiny':!list_of_pp_loaded_classic[list_of_messages.length -1 - i]}">
                                        <img (load)="loaded_image(-(list_of_messages.length -1 - i)-1)"
                                            [ngClass]="{'invisible':!list_of_pp_loaded_classic[list_of_messages.length -1 - i]}"
                                            [src]="friend_picture">
                                    </div>
                                </div>

                                <div class="content only-message"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status=='deleted'"><i>Message supprimé</i>
                                </div>
                                <div class="content"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='deleted'"

                                    [matTooltip]="!can_show_send_icon?list_of_messages_date[list_of_messages.length -1 - i]:null"
                                    matTooltipClass='linkarts-tooltip'
                                    [matTooltipPosition]="'below'"
                                    [matTooltipShowDelay]="100"

                                    [ngClass]="{
                                        'detect-scroll':can_show_send_icon,
                                        'friend-top-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user && list_of_messages[list_of_messages.length- i-2].id_user==list_of_messages[list_of_messages.length- i-1].id_user)
                                        || (!list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i-2].id_user),
                                        'friend-middle-message':list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id!=list_of_messages[list_of_messages.length- i-2].id_user  && current_user_id!=list_of_messages[list_of_messages.length- i].id_user,
                                        'friend-bottom-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i-2].id_user && current_user_id!=list_of_messages[list_of_messages.length- i].id_user)
                                            || (list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2] && current_user_id!=list_of_messages[list_of_messages.length- i].id_user),

                                        'only-message':
                                        (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] 
                                            && (
                                                   (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user  && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i].is_from_server)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i].is_from_server)
                                                
                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                )
                                        ) 
                                        || ( !list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i] && 
                                                (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user 
                                                || list_of_messages[list_of_messages.length- i].is_from_server
                                                || list_of_messages[list_of_messages.length- i-1].date_shown)
                                            ) 
                                        || ( !list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && 
                                                (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user 
                                                || list_of_messages[list_of_messages.length- i-2].is_from_server
                                                || list_of_messages[list_of_messages.length- i-2].date_shown)
                                            )
                                        || ( !list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2]
                                        )}">
                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_a_response"
                                        class="response-content text-with-line-break"
                                        (click)="show_response(list_of_messages.length -1 - i)">
                                            {{list_of_messages[list_of_messages.length -1 - i].message_responding_to}}
                                    </div>


                                    <div class="emoji-reaction-content"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user != list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver">
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver"
                                            [ngClass]="{'second-emoji':list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user}">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                    </div>
                                    <div class="emoji-reaction-content"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user && 
                                                (list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user == list_of_messages[list_of_messages.length -1 - i].emoji_reaction_receiver)">
                                        <div class="emoji-reaction-content-center"
                                            *ngIf="list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user">
                                            <ngx-emoji useButton="true" set="apple"
                                                emoji="{{list_of_messages[list_of_messages.length -1 - i].emoji_reaction_user}}"
                                                size="20"></ngx-emoji>
                                        </div>
                                        <span style="color: darkgrey;padding: 0px 5px 0px 5px;">2</span>
                                    </div>


                                    <div [innerHTML]="convert(list_of_messages.length -1 - i)" *ngIf="!list_of_messages[list_of_messages.length -1 - i].is_an_attachment" class="text-with-line-break">
                                        
                                    </div>
                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_an_attachment">
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message'"
                                            (click)="show_images(list_of_messages.length -1 - i)"
                                            class="image-container">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                               
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">
                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment'"
                                            class="image-container"
                                            (click)="show_images(list_of_messages.length -1 - i)">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">

                                        </div>
                                        <div class="d-flex align-items-center" *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='file_attachment'">
                                            <div class="attachment-icon" [@enterAnimation]>
                                                <mat-icon [ngClass]="{'invisible': !show_icon }">insert_drive_file</mat-icon>
                                            </div>
                                            <a [href]="list_of_messages_files[list_of_messages.length -1 - i]" [download]="list_of_messages[list_of_messages.length -1 - i].attachment_name">{{list_of_messages[list_of_messages.length -1 - i].attachment_name}}</a>
                                        </div>
                                    </div>
                                </div>


                                <div class="options margin-right" [ngClass]="{ 'opacity1': friendMessageOpenedOptions==i }">
                                    

                                    
                                    <button (menuClosed)="friendMessageOptionsClosed();" (menuOpened)="friendMessageOptionsOpened(i);" (click)="show_reactions(i,$event)" [matMenuTriggerFor]="reactions"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            sentiment_satisfied</mat-icon>
                                    </button>

                                    <mat-menu #reactions="matMenu" class="reactions-mat-menu">
                                        <button class="reaction-menu-item" *ngFor="let emoji of emojis_list; let j=index">
                                            <ngx-emoji (emojiClick)="reaction_click($event,list_of_messages.length -1 - i)" useButton="true" set="apple" emoji="{{emoji}}" size="26"></ngx-emoji>
                                        </button>
                                    </mat-menu>

                                    

                                    <button (menuClosed)="friendMessageOptionsClosed();" (menuOpened)="friendMessageOptionsOpened(i);" (click)="edit(list_of_messages.length -1 - i)"
                                        *ngIf="(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')   && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            edit</mat-icon>
                                    </button>



                                    <button (click)="respond_to_message(list_of_messages.length -1 - i)"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            reply</mat-icon>
                                    </button>

                                  
                                </div>

                            </div>

                        </ng-container>

                        <!-- MESSAGES SERVER -->
                        <!--  MESSAGES SERVER -->
                        <!--  MESSAGES SERVER  -->
                        <!--  MESSAGES SERVER  -->

                        <div class="new-contact-message-content" *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='New' && list_of_messages[list_of_messages.length -1 - i].is_from_server">
                            <span>
                                <mat-icon [ngClass]="{'invisible': !show_icon }">person_add</mat-icon>
                                <b>{{friend_name}}</b> fait désormais partie de vos contacts
                            </span>
                        </div>

                        <div class="new-contact-message-content" *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='new_section' && list_of_messages[list_of_messages.length -1 - i].is_from_server">
                            <span>
                                Bienvenue dans la section <b>{{chat_section_to_open}}</b>
                            </span>
                        </div>

                    </div>


                    <button [disabled]="show_spinner_for_less" *ngIf="show_research_results && show_less_results" class="show-more" (click)="see_less_messages();">
                        <ng-container *ngIf="!show_spinner_for_less">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">expand_more</mat-icon>
                            <span>Voir plus</span>
                        </ng-container>
                        <div class="loading-dots" *ngIf="show_spinner_for_less">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </button>
                    
                </div>
            </div>





































            






            <!--
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                    DEBUT DES MESSAGES DE GROUPES
                -->




            <div #myScrollContainer class="messages-container" (scroll)="onScroll($event)"
                [ngClass]="{'invisible':!put_messages_visible || !list_of_users_names_retrieved}"
                *ngIf="friend_type!='user'">


                <div *ngIf='display_messages' style="width:100%;overflow: hidden;">

                    <div class="loading-dots-container loading-messages" *ngIf="show_spinner">
                        <div class="loading-dots">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>

                    <div *ngIf="trigger_no_more" class="text-in-middle">
                        <span>Début de la discussion : {{list_of_messages_date[list_of_messages.length -1]}}</span>
                    </div>

                    <button [disabled]="show_spinner_for_more" *ngIf="show_research_results && !trigger_no_more" class="show-more" (click)="see_more_messages();">
                        <ng-container *ngIf="!show_spinner_for_more">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">expand_less</mat-icon>
                            <span>Voir plus</span>
                        </ng-container>
                        <div class="loading-dots" *ngIf="show_spinner_for_more">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </button>
                    

                    <div #message_children *ngFor="let item of list_of_messages; let i = index" class="message">

                        <div *ngIf="list_of_messages[list_of_messages.length- i]">
                            <div *ngIf="get_time_of_date(list_of_messages[list_of_messages.length- i].createdAt)!=get_time_of_date(list_of_messages[list_of_messages.length -1 - i].createdAt)
                                && (list_of_messages[list_of_messages.length -1 - i].createdAt || !today_triggered)" class="text-in-middle">
                                <span>{{show_date_of_timestamp(list_of_messages.length -1 - i)}}</span>
                            </div>
                        </div>



                        <!-- MES MESSAGES -->
                        <!-- MES MESSAGES -->
                        <!-- MES MESSAGES -->
                        <!-- MES MESSAGES -->

                        <ng-container
                            *ngIf="list_of_messages[list_of_messages.length -1 - i].id_user==current_user_id && !list_of_messages[list_of_messages.length -1 - i].is_from_server">
                            <div class="my-message-content"
                                [ngClass]="{
                                'contains-picture':(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                'less-margin-for-user':list_of_messages[list_of_messages.length- i-2] &&  !list_of_messages[list_of_messages.length- i-2].is_from_server && current_user_id==list_of_messages[list_of_messages.length- i-2].id_user,
                                'more-margin-top-for-name':list_of_messages[list_of_messages.length- i] && (list_of_messages[list_of_messages.length- i].id_user!=current_user_id || list_of_messages[list_of_messages.length- i].is_from_server)  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                'margin-for-emojis': (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id])  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                'deleted': list_of_messages[list_of_messages.length -1 - i].status=='deleted',
                                
                                'padding-for-no-state': !(list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length>1 && get_list_of_view_names(i))
                                && !((list_of_messages[list_of_messages.length -1 - i].status=='received' || list_of_messages[list_of_messages.length -1 - i].status=='deleted') &&  list_of_messages[list_of_messages.length -1 - i].list_of_users_who_saw.length==1),
                                    
                                'message-search-style': searched_message==i  }">

                                <div class="my-user-name"
                                    *ngIf="list_of_messages[list_of_messages.length- i] && (list_of_messages[list_of_messages.length- i].id_user!=current_user_id || list_of_messages[list_of_messages.length- i].is_from_server)">
                                    <span>
                                        {{list_of_users_names[list_of_messages[list_of_messages.length- i-1].id_user]}}
                                    </span>
                                </div>


                                <div class="options margin-left" [ngClass]="{ 'opacity1': myMessageOpenedOptions==i }">
                                    <button (menuClosed)="myMessageOptionsClosed();" (menuOpened)="myMessageOptionsOpened(i);"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].id && list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'"[matMenuTriggerFor]="artworkOptions">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            more_horiz</mat-icon>
                                    </button>
                                    
                                    <button (click)="respond_to_message(list_of_messages.length -1 - i)"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].id && list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            reply</mat-icon>
                                    </button>



                                    <button (menuClosed)="myMessageOptionsClosed();" (menuOpened)="myMessageOptionsOpened(i);" (click)="show_reactions(i,$event)" [matMenuTriggerFor]="reactions"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            sentiment_satisfied</mat-icon>
                                    </button>

                                    <mat-menu #reactions="matMenu" class="reactions-mat-menu">
                                        <button class="reaction-menu-item" *ngFor="let emoji of emojis_list; let j=index">
                                            <ngx-emoji (emojiClick)="reaction_click($event,list_of_messages.length -1 - i)" useButton="true" set="apple" emoji="{{emoji}}" size="26"></ngx-emoji>
                                        </button>
                                    </mat-menu>

                                    <mat-menu #artworkOptions="matMenu" class="chat-mat-menu">

                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && !list_of_messages[list_of_messages.length -1 - i].attachment_name.includes('.svg')"
                                            (click)="edit(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">edit
                                            </mat-icon>
                                            <span>Éditer</span>
                                        </button>

                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].is_an_attachment) && list_of_folders_retrieved  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && list_of_folders.length>0 && (list_of_messages[list_of_messages.length -1 - i].id_folder==0 || !list_of_messages[list_of_messages.length -1 - i].id_folder)"
                                            (click)="archive(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">bookmark
                                            </mat-icon>
                                            <span>Archiver</span>
                                        </button>


                                        <button class="chat-menu-item" mat-menu-item *ngIf="(list_of_messages[list_of_messages.length -1 - i].is_an_attachment) && list_of_folders_retrieved  && list_of_messages[list_of_messages.length -1 - i].status!='deleted' && list_of_messages[list_of_messages.length -1 - i].id_folder>0"
                                            (click)="unarchive(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">turned_in_not
                                            </mat-icon>
                                            <span>Désarchiver</span>
                                        </button>

                                        <button class="chat-menu-item" mat-menu-item
                                            (click)="delete_message(list_of_messages.length -1 - i)">
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">delete_outline
                                            </mat-icon>
                                            <span>Supprimer</span>
                                        </button>

                            
                                        <div class="chat-menu-item date-menu" mat-menu-item>
                                            <mat-icon [ngClass]="{'invisible': !show_icon }">history
                                            </mat-icon>
                                            <span>{{list_of_messages_date[list_of_messages.length -1 - i]}}</span>
                                        </div>
                                    </mat-menu>
                                </div>



                                <div class="content only-message"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status=='deleted'"><i>Message supprimé</i>
                                </div>

                                <div *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='deleted'"
                                    class="content"

                                    [matTooltip]="!can_show_send_icon?list_of_messages_date[list_of_messages.length -1 - i]:null"
                                    matTooltipClass='linkarts-tooltip'
                                    [matTooltipPosition]="'below'"
                                    [matTooltipShowDelay]="100"

                                    [ngClass]="{
                                        'detect-scroll':can_show_send_icon,
                                        'only-message':
                                        (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] 
                                            && (
                                                    (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user  && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i].is_from_server)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i].is_from_server)

                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                )
                                        ) 
                                        || ( !list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i] && 
                                            (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user 
                                            || list_of_messages[list_of_messages.length- i].is_from_server
                                            || list_of_messages[list_of_messages.length- i-1].date_shown)
                                            ) 
                                        || ( !list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && 
                                            (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user 
                                            || list_of_messages[list_of_messages.length- i-2].is_from_server
                                            || list_of_messages[list_of_messages.length- i-2].date_shown)
                                            )
                                        || ( !list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2]
                                        ),
                                        'my-top-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user && list_of_messages[list_of_messages.length- i-2].id_user==list_of_messages[list_of_messages.length- i-1].id_user)
                                                || (!list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i-2].id_user),
                                        'my-middle-message':list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i-2].id_user  && current_user_id==list_of_messages[list_of_messages.length- i].id_user,
                                        'my-bottom-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && current_user_id!=list_of_messages[list_of_messages.length- i-2].id_user && current_user_id==list_of_messages[list_of_messages.length- i].id_user)
                                            || (list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2] && current_user_id==list_of_messages[list_of_messages.length- i].id_user)}">


                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_a_response"
                                        class="response-content text-with-line-break"
                                        (click)="show_response(list_of_messages.length -1 - i)">
                                            {{list_of_messages[list_of_messages.length -1 - i].message_responding_to}}
                                    </div>


                                    <div class="emoji-reaction-content"
                                        (click)="see_emoji_reaction_by_user(list_of_messages[list_of_messages.length -1 - i].id)"
                                        *ngIf="list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id]">
                                        <ng-container
                                            *ngFor="let emoji of list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].sort();let j=index">
                                            <div class="emoji-reaction-content-center" *ngIf="
                                            (j==0 
                                                || (j>0 && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]!=list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j])
                                            ) ">
                                                <ngx-emoji useButton="true" set="apple" emoji="{{emoji}}" size="20">
                                                </ngx-emoji>
                                            </div>
                                            <div class="emoji-reaction-content-center" *ngIf=" 
                                                j>0 
                                                && (
                                                        (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].length -1==j
                                                             && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]==list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                        )
                                                        ||
                                                        (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].length -1>j
                                                             && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]==list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                             && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j+1]!=list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                        )
                                                    )
                                                ">
                                                <span style="color: darkgrey;padding: 0px 5px 0px 5px;">
                                                    {{get_number_of_same_emoji(list_of_messages[list_of_messages.length -1 - i].id,list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j])}}
                                                </span>
                                            </div>
                                        </ng-container>

                                    </div>

                                    <div [innerHTML]="convert(list_of_messages.length -1 - i)" *ngIf="!list_of_messages[list_of_messages.length -1 - i].is_an_attachment" class="text-with-line-break">
                                        
                                    </div>

                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_an_attachment">
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message'"
                                            (click)="show_images(list_of_messages.length -1 - i)"
                                            class="image-container">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                               
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">
                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment'"
                                            class="image-container"
                                            (click)="show_images(list_of_messages.length -1 - i)">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">

                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='file_attachment'" class="d-flex align-items-center">
                                            <a [href]="list_of_messages_files[list_of_messages.length -1 - i]"
                                                [download]="list_of_messages[list_of_messages.length -1 - i].attachment_name">{{list_of_messages[list_of_messages.length -1 - i].attachment_name}}</a>
                                        </div>
                                    </div>
                                </div>

                                
                                <div class="state" [@enterAnimation]
                                    [matTooltip]="get_list_of_view_names(i)"
                                    matTooltipClass='linkarts-tooltip'
                                    [matTooltipPosition]="'below'"
                                    [matTooltipShowDelay]="100"
                                    *ngIf="list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length>1 && get_list_of_view_names(i)">
                                    <div class="friend-picture" [ngClass]="{'shiny': !top_pp_loaded }">
                                        <img [src]="friend_picture" (load)="top_pp_is_loaded()" [ngClass]="{'invisible': !top_pp_loaded }">
                                    </div>
                                </div>
                                <div class="state" [@enterAnimation] *ngIf="(list_of_messages[list_of_messages.length -1 - i].status=='received' || list_of_messages[list_of_messages.length -1 - i].status=='deleted') &&  list_of_messages[list_of_messages.length -1 - i].list_of_users_who_saw.length==1">                                    
                                    <div>
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">done</mat-icon>
                                    </div>
                                </div>
                            </div>

                        </ng-container>


                        <!-- MESSAGES AUTRES UTILISATEURS -->
                        <!--  MESSAGES AUTRES UTILISATEURS  -->
                        <!--  MESSAGES AUTRES UTILISATEURS  -->
                        <!--  MESSAGES AUTRES UTILISATEURS  -->


                        <ng-container
                            *ngIf="list_of_messages[list_of_messages.length -1 - i].id_user!=current_user_id && !list_of_messages[list_of_messages.length -1 - i].is_from_server">

                            <div class="friend-message-content"
                                [ngClass]="{
                                    'contains-picture':(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'less-margin-for-user':list_of_messages[list_of_messages.length- i-2] &&  !list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length -1 - i].id_user==list_of_messages[list_of_messages.length- i-2].id_user,
                                    'more-margin-top-for-name':list_of_messages[list_of_messages.length- i] && (list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user || list_of_messages[list_of_messages.length- i].is_from_server)  && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'margin-for-emojis': (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id]) && list_of_messages[list_of_messages.length -1 - i].status!='deleted',
                                    'deleted': list_of_messages[list_of_messages.length -1 - i].status=='deleted',

                                    'padding-for-no-state': !(list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length>1 && get_list_of_view_names(i)),

                                    'message-search-style': searched_message==i  }">


                                <div class="friend-user-name"
                                    *ngIf="list_of_messages[list_of_messages.length- i] && (list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user || list_of_messages[list_of_messages.length- i].is_from_server)">
                                    <span>
                                        {{list_of_users_names[list_of_messages[list_of_messages.length- i-1].id_user]}}
                                    </span>
                                </div>


                                <!--autres messages-->
                                <div class="state" [@enterAnimation]
                                [matTooltip]="get_list_of_view_names_friend(i)"
                                matTooltipClass='linkarts-tooltip'
                                [matTooltipPosition]="'below'"
                                [matTooltipShowDelay]="100"
                                *ngIf="list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length>1 && get_list_of_view_names(i)">
                                    <div class="friend-picture" [ngClass]="{'shiny': !users_pp_loaded[list_of_messages[list_of_messages.length- i-1].id_user] }">
                                        
                                        <img 
                                        [customObservable]="scroll"
                                        [lazyLoad]="list_of_users_profile_pictures[list_of_messages[list_of_messages.length- i-1].id_user]" loading="lazy"
                                        (load)="load_users_pp(list_of_messages[list_of_messages.length- i-1].id_user)"
                                        [ngClass]="{'invisible':!users_pp_loaded[list_of_messages[list_of_messages.length- i-1].id_user]}">

                                    </div>
                                </div>

                                <div class="content only-message"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status=='deleted'"><i>Message supprimé</i>
                                </div>

                                <div class="content"
                                    *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='deleted'"

                                    [matTooltip]="!can_show_send_icon?list_of_messages_date[list_of_messages.length -1 - i]:null"
                                    matTooltipClass='linkarts-tooltip'
                                    [matTooltipPosition]="'below'"
                                    [matTooltipShowDelay]="100"

                                    [ngClass]="{
                                        'detect-scroll':can_show_send_icon,
                                        'only-message':
                                        (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] 
                                            && (
                                                    (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user  && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i].is_from_server)
                                                || (list_of_messages[list_of_messages.length- i-2].is_from_server && list_of_messages[list_of_messages.length- i].is_from_server)

                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user)
                                                || (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                || (list_of_messages[list_of_messages.length- i-2].date_shown && list_of_messages[list_of_messages.length- i-1].date_shown)
                                                )
                                        ) 
                                        || ( !list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i] && 
                                            (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i].id_user 
                                                || list_of_messages[list_of_messages.length- i].is_from_server
                                                || list_of_messages[list_of_messages.length- i-1].date_shown)
                                            ) 
                                        || ( !list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && 
                                            (list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user 
                                                || list_of_messages[list_of_messages.length- i-2].is_from_server
                                                || list_of_messages[list_of_messages.length- i-2].date_shown)
                                            )
                                        || ( !list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2]),

                                        'friend-top-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i].id_user!=list_of_messages[list_of_messages.length- i-1].id_user && list_of_messages[list_of_messages.length- i-2].id_user==list_of_messages[list_of_messages.length- i-1].id_user)
                                            || (!list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i-2].id_user),
                                        'friend-middle-message':list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i-2].id_user  && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i].id_user,
                                        'friend-bottom-message': (list_of_messages[list_of_messages.length- i] && list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user!=list_of_messages[list_of_messages.length- i-2].id_user && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i].id_user)
                                            || (list_of_messages[list_of_messages.length- i] && !list_of_messages[list_of_messages.length- i-2] && list_of_messages[list_of_messages.length- i-1].id_user==list_of_messages[list_of_messages.length- i].id_user)}">

                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_a_response"
                                        class="response-content text-with-line-break"
                                        (click)="show_response(list_of_messages.length -1 - i)">
                                            {{list_of_messages[list_of_messages.length -1 - i].message_responding_to}}
                                    </div>

                                    <div class="emoji-reaction-content"
                                        (click)="see_emoji_reaction_by_user(list_of_messages[list_of_messages.length -1 - i].id)"
                                        *ngIf="list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id]">
                                        <ng-container
                                            *ngFor="let emoji of list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].sort();let j=index">
                                            <div class="emoji-reaction-content-center" *ngIf="
                                                    (j==0 
                                                        || (j>0 && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]!=list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j])
                                                    ) ">
                                                <ngx-emoji useButton="true" set="apple" emoji="{{emoji}}" size="20">
                                                </ngx-emoji>
                                            </div>
                                            <div class="emoji-reaction-content-center" *ngIf=" 
                                                        j>0 
                                                        && (
                                                                (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].length -1==j
                                                                     && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]==list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                                )
                                                                ||
                                                                (list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id].length -1>j
                                                                     && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j-1]==list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                                     && list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j+1]!=list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j]
                                                                )
                                                            )
                                                        ">
                                                <span style="color: darkgrey;padding: 0px 5px 0px 5px;">{{get_number_of_same_emoji(list_of_messages[list_of_messages.length -1 - i].id,list_of_messages_reactions[list_of_messages[list_of_messages.length -1 - i].id][j])}}
                                                </span>
                                            </div>
                                        </ng-container>


                                    </div>

                                    <div [innerHTML]="convert(list_of_messages.length -1 - i)" *ngIf="!list_of_messages[list_of_messages.length -1 - i].is_an_attachment" class="text-with-line-break">
                                        
                                    </div>

                                    <div *ngIf="list_of_messages[list_of_messages.length -1 - i].is_an_attachment">
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message'"
                                            (click)="show_images(list_of_messages.length -1 - i)"
                                            class="image-container">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                               
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">
                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment'"
                                            class="image-container"
                                            (click)="show_images(list_of_messages.length -1 - i)">
                                            <img (load)="loaded_image(list_of_messages.length -1 - i)"
                                            [customObservable]="scroll"
                                            *ngIf="can_load_images"
                                                [ngClass]="{'invisible':!list_of_images_loaded[list_of_messages.length -1 - i]}"
                                                [lazyLoad]="list_of_messages_pictures[list_of_messages.length -1 - i]" loading="lazy">

                                        </div>
                                        <div *ngIf="list_of_messages[list_of_messages.length -1 - i].attachment_type=='file_attachment'" class="d-flex align-items-center">
                                            <div class="attachment-icon" [@enterAnimation]>
                                                <mat-icon [ngClass]="{'invisible': !show_icon }">insert_drive_file</mat-icon>
                                            </div>
                                            <a [href]="list_of_messages_files[list_of_messages.length -1 - i]" [download]="list_of_messages[list_of_messages.length -1 - i].attachment_name">{{list_of_messages[list_of_messages.length -1 - i].attachment_name}}</a>
                                        </div>
                                    </div>
                                </div>


                                <div class="options margin-right" [ngClass]="{ 'opacity1': friendMessageOpenedOptions==i }">

                                    <button (menuClosed)="friendMessageOptionsClosed();" (menuOpened)="friendMessageOptionsOpened(i);" (click)="show_reactions(i,$event)" [matMenuTriggerFor]="reactions"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            sentiment_satisfied</mat-icon>
                                    </button>

                                    <mat-menu #reactions="matMenu" class="reactions-mat-menu">
                                        <button class="reaction-menu-item" *ngFor="let emoji of emojis_list; let j=index">
                                            <ngx-emoji (emojiClick)="reaction_click($event,list_of_messages.length -1 - i)" useButton="true" set="apple" emoji="{{emoji}}" size="26"></ngx-emoji>
                                        </button>
                                    </mat-menu>


                                    <button (menuClosed)="friendMessageOptionsClosed();" (menuOpened)="friendMessageOptionsOpened(i);" (click)="edit(list_of_messages.length -1 - i)"
                                        *ngIf="(list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_attachment' || list_of_messages[list_of_messages.length -1 - i].attachment_type=='picture_message')  && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            edit</mat-icon>
                                    </button>

                                    <button (click)="respond_to_message(list_of_messages.length -1 - i)"
                                        *ngIf="list_of_messages[list_of_messages.length -1 - i].status!='sent' && list_of_messages[list_of_messages.length -1 - i].status!='deleted'">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">
                                            reply</mat-icon>
                                    </button>

                                </div>


                                <div class="user-profiles-who-saw-friend"
                                    *ngIf="list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length>1">
                                    <div
                                        *ngFor="let id of list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw">
                                        <div class="user-profile-who-saw-friend"
                                            *ngIf="id!=current_user_id && !has_user_saw_something_else_after(id,list_of_messages.length- i-1)">
                                            <img 
                                            [customObservable]="scroll"
                                            [lazyLoad]="list_of_users_profile_pictures[id]" loading="lazy" 
                                            (load)="load_users_pp(id)"
                                                [ngClass]="{'invisible':!users_pp_loaded[id]}">
                                            <div class="display-who-saw">
                                                <span> vu par {{list_of_users_names[id]}}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="display-seen-by-all-friend"
                                    *ngIf="i==list_of_messages.length-1 && list_of_messages[list_of_messages.length- i-1].list_of_users_who_saw.length==list_of_messages[list_of_messages.length- i-1].list_of_users_in_the_group.length ">
                                    <span> vu par tous</span>
                                </div>

                            </div>

                        </ng-container>



                        <!-- MESSAGES SERVER -->
                        <!--  MESSAGES SERVER -->
                        <!--  MESSAGES SERVER  -->
                        <!--  MESSAGES SERVER  -->
                        <ng-container *ngIf="list_of_messages[list_of_messages.length -1 - i].is_from_server">

                            <div class="new-contact-message-content"
                                *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='New'">
                                <span>
                                    <mat-icon [ngClass]="{'invisible': !show_icon }">group</mat-icon>
                                    Bienvenue dans le groupe : <b>{{friend_name}}</b></span>
                            </div>

                            <div class="new-contact-message-content" *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='new_section'">
                                <span>
                                    <mat-icon [ngClass]="{'invisible': !show_icon }">person_add</mat-icon>
                                    Bienvenue dans la section <b>{{chat_section_to_open}}</b>
                                </span>
                            </div>

                            <div class="new-contact-message-content"
                                *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='Exit'">
                                <span *ngIf="list_of_messages[list_of_messages.length -1 - i].real_id_user">
                                    <mat-icon [ngClass]="{'invisible': !show_icon }">person_off</mat-icon>
                                    <b>{{get_name_of_someone_who_exit_group(list_of_messages[list_of_messages.length -1 - i].real_id_user,1,0)}}</b> a quitté le groupe
                                </span>
                                <span *ngIf="!list_of_messages[list_of_messages.length -1 - i].real_id_user">
                                    <mat-icon [ngClass]="{'invisible': !show_icon }">person_off</mat-icon>
                                    <b>{{get_name_of_someone_who_exit_group(list_of_messages[list_of_messages.length -1 - i].id_user,1,0)}}</b> a quitté le groupe
                                </span>
                            </div>

                            <ng-container *ngIf="list_of_messages[list_of_messages.length -1 - i].message=='New_friend_in_the_group'">
                                <div  *ngFor="let item of list_of_messages[list_of_messages.length -1 - i].list_of_names_added; let j=index" class="new-contact-message-content">
                                    <span *ngIf="list_of_messages[list_of_messages.length -1 - i].real_id_user">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">person_add</mat-icon>
                                        <b>{{get_name_of_someone_who_exit_group(list_of_messages[list_of_messages.length -1 - i].real_id_user,2,item)}}</b> 
                                    </span>
                                   <span *ngIf="!list_of_messages[list_of_messages.length -1 - i].real_id_user">
                                        <mat-icon [ngClass]="{'invisible': !show_icon }">person_add</mat-icon>
                                        <b>{{get_name_of_someone_who_exit_group(list_of_messages[list_of_messages.length -1 - i].id_user,2,item)}}</b>
                                    </span>
                                </div>
                            </ng-container>

                        </ng-container>

                    </div>


                    <button [disabled]="show_spinner_for_less" *ngIf="show_research_results && show_less_results" class="show-more" (click)="see_less_messages();">
                        <ng-container *ngIf="!show_spinner_for_less">
                            <mat-icon [ngClass]="{'invisible': !show_icon }">expand_more</mat-icon>
                            <span>Voir plus</span>
                        </ng-container>
                        <div class="loading-dots" *ngIf="show_spinner_for_less">
                            &nbsp; <span>.</span><span>.</span><span>.</span>
                        </div>
                    </button>
                </div>
            </div>
























        </div>




        <!-------------------------------------->
        <!-------------------------------------->
        <!--PARTIE BASSE DU CHAT-->
        <!-------------------------------------->
        <!-------------------------------------->
        <div *ngIf="!block_chat" [formGroup]="message_group" novalidate class="bottom-container" #bottomContainer (resized)="onResized($event)">

            <div class="writing-container" *ngIf="display_writing" [@enterFromBottomAnimation]>
                <div class="writing">
                    {{friend_name}} est en train d'écrire dans {{section_where_is_writing}}&nbsp; <span>.</span><span>.</span><span>.</span>
                </div>
            </div>
            <div class="writing-container" *ngIf="list_of_users_writing.length == 1" [@enterFromBottomAnimation]>
                <div class="writing">
                    {{list_of_users_names[ list_of_users_writing[0] ]}} est en train d'écrire dans {{section_where_is_writing}}&nbsp; <span>.</span><span>.</span><span>.</span>
                </div>
            </div>
            <div class="writing-container" *ngIf="list_of_users_writing.length == 2" [@enterFromBottomAnimation]>
                <div class="writing">
                    {{list_of_users_names[ list_of_users_writing[0] ]}} et {{list_of_users_names[ list_of_users_writing[1] ]}} écrivent dans {{section_where_is_writing}}&nbsp; <span>.</span><span>.</span><span>.</span>
                </div>
            </div>
            <div class="writing-container" *ngIf="list_of_users_writing.length > 2" [@enterFromBottomAnimation]>
                <div class="writing">
                    Plusieurs membres écrivent dans {{section_where_is_writing}}&nbsp; <span>.</span><span>.</span><span>.</span>
                </div>
            </div>

            <div #emojisSpinner class="emojis-spinner" [@enterAnimation]>
                <mat-spinner diameter="20"></mat-spinner>
            </div>

            <div *ngIf="load_emoji" #emojis class="emojis-main-container" [@enterAnimation]>
                <div class="emojis-container">
                    <emoji-mart [set]="set" [useButton]="true" [sheetSize]="'16'" [showPreview]="true" [enableSearch]="false" [isNative]="native" [hideRecent]="false"
                        (emojiSelect)="handleClick($event)">
                    </emoji-mart>
                </div>
            </div>

            <div class="send-message-container">

                <div *ngIf="respond_to_a_message" class="response">
                    <div class="left-container" *ngIf="friend_type=='user'" [@enterFromBottomAnimation]>
                        <span *ngIf="id_user_message_responding_to!=current_user_id">Réponse à <b>{{friend_name}}</b></span>
                        <span *ngIf="id_user_message_responding_to==current_user_id">Réponse à <b>{{current_user_name}}</b></span>
                        <span style="line-height: 14px">{{message_responding_to}}</span>
                        <span  ><b>Envoyé le</b> : {{date_of_message_responsing_to}}</span>
                    </div>
                    <div class="left-container"  *ngIf="friend_type!='user'" [@enterFromBottomAnimation]>
                        <span>Réponse à <b>{{list_of_users_names[id_user_message_responding_to]}}</b></span>
                        <span style="line-height: 14px">{{message_responding_to}}</span>
                        <span><b>Envoyé le</b> : {{date_of_message_responsing_to}}</span>
                    </div>
                    <button (click)="cancel_response()" [@enterFromBottomAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                    </button>
                </div>

                <div class="attachments" *ngIf="display_attachments">
                    <div *ngFor="let item of attachments; let i=index" class="attachment-container"
                        [@enterFromBottomAnimation]>

                        <ng-container
                            *ngIf="attachments_type[i]=='picture_message' || attachments_type[i]=='picture_attachment'">
                            <button (click)="remove_attachment(i)" [@enterAnimation]>
                                <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                            </button>
                            <div class="attachment-picture" [@enterAnimation]>
                                <img [src]="attachments_safe[i]">
                            </div>
                        </ng-container>

                        <ng-container *ngIf="attachments_type[i]=='file_attachment'">
                            <button (click)="remove_attachment(i)" [@enterAnimation]>
                                <mat-icon [ngClass]="{'invisible': !show_icon }">close</mat-icon>
                            </button>
                            <div class="attachment-picture" [@enterAnimation]>
                                <mat-icon [ngClass]="{'invisible': !show_icon }">insert_drive_file</mat-icon>
                            </div>
                        </ng-container>
                        <span [@enterAnimation]><i>{{attachments_name[i]}}</i></span>

                    </div>

                    <div *ngIf="attachments && attachments.length==1 && (attachments_type[0]=='picture_message' || attachments_type[0]=='picture_attachment')" 
                    (click)="edit(-1);" class="edit-picture" [@enterFromBottomAnimation]>
                        <mat-icon [ngClass]="{'invisible': !show_icon }">edit</mat-icon>
                        <span>Éditer</span>
                    </div>

                </div>


                <div class="send_message">

                    <div class="add-file" *ngIf="spam=='false'">
                        <label>
                            <div>
                                <mat-icon [ngClass]="{'invisible': !show_icon }" class="rotate-icon">attachment</mat-icon>
                            </div>
                            <input (click)="onFileClick($event)" type="file" ng2FileSelect [uploader]="uploader"
                                style="display: none;" />
                        </label>
                    </div>

                    <div class="textarea-container">
                        <textarea matInput #input cdkTextareaAutosize formControlName="message" maxlength="3000"
                            (blur)="blur($event)"
                            (keydown)="on_keydown($event)" (keyup)="on_keyup($event)" (input)="check_message_for_phone()" (click)="activateFocus()" (blur)="desactivateFocus()"
                            (paste)="onPaste($event);" onblur="this.placeholder = 'Ecrivez un message...'" type="text"
                            [placeholder]="'Ecrivez un message...'" autocomplete="on" autocorrect="on"
                            autocapitalize="on" spellcheck="true"></textarea>

                        <div class="messages-options-container">

                            <div class="icon-messenger-container">
                                <div class="icon-messenger" (click)="send_message_phone()" [ngClass]="{'invisible': !show_send_icon || !can_show_send_icon}">

                                </div>
                            </div>

                            <button #emoji_button (click)="open_emojis()"
                            matTooltip="Emojis"
                            matTooltipClass='linkarts-tooltip'
                            [matTooltipPosition]="'below'"
                            [matTooltipShowDelay]="100">
                                <mat-icon [ngClass]="{'invisible': !show_icon }">sentiment_satisfied</mat-icon>
                            </button>
                            
                            
                        </div>
                        
                    </div>
                </div>

            </div>
        </div>


    </div>





    <div class="right-container" [ngClass]="{'show-me-on-small-screen': right_container_is_opened }" *ngIf="spam=='false'">

        <app-chat-right-container [chat_section_to_open]="chat_section_to_open" [id_chat_section]="id_chat_section"
            [spam]="spam" [current_user_id]="current_user_id" [current_user_pseudo]="current_user_pseudo"
            [current_user_name]="current_user_name" [current_user_profile_picture]="current_user_profile_picture"
            [chat_friend_id]="chat_friend_id" [friend_type]="friend_type" [friend_id]="friend_id"
            [friend_pseudo]="friend_pseudo" [friend_name]="friend_name" [friend_picture]="friend_picture"

            [list_of_chat_sections]="list_of_chat_sections"
            
            [number_of_sections_unseen]="number_of_sections_unseen"
            [list_of_chat_sections_notifications]="list_of_chat_sections_notifications"
            [show_notification_message]="show_notification_message"
            [activate_add_chat_section]="activate_add_chat_section"
            (addChatSection)="add_chat_section()"
            (addChatSectionName)="add_chat_section_name($event)"
            (deletedChatSection)="delete_chat_section()"
            (cancelAddSection)="cancel_add_section()"
            (changeSection)="changed_section($event)"
            (arrowBack)="change_right_container()"
            (folders_emitter)="get_folders_emitter($event)"
            (archive_from_right_emit)="archive_from_right($event)"
            >
        </app-chat-right-container>

    </div>

</div>